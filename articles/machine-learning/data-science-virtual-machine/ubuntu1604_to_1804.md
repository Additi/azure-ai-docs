---
title: How to upgrade your Data Science Virtual Machine to Ubuntu 18.04
titleSuffix: Azure Data Science Virtual Machine 
description: Learn how to upgrade from CentOS and Ubuntu 16.04 to the latest Ubuntu 18.04 Data Science Virtual Machine.
keywords: deep learning, AI, data science tools, data science virtual machine, team data science process
services: machine-learning
ms.service: machine-learning
ms.subservice: data-science-vm
author: samkemp
ms.author: samkemp
ms.topic: conceptual
ms.date: 10/01/2020
---

# Upgrade your Data Science Virtual Machine to Ubuntu 18.04

intro tk

## Prerequisites

1. Make sure there are no drivers that depend on Ubuntu 16.04. {>> Is there a link for this? AFAICT this is either irrelevant (for a DSVM) or hard (requires painstaking `lpsci:` review) <<}

2. Create a backup before any Operating System migration. {>> Relevant for DSVM? Is this not taken care of by "Create Snapshot" step? <<}

## Overview

This section includes the migration plan for Ubuntu 18.04 from 16.04. There are two possible ways to migrate:

- In-place migration, also called "same server" migration. This migration upgrades the existing VM without creating a new virtual machine.
- Side-by-side migration, also called "inter-server" migration. This migration transfers data from the existing virtual machine to a newly created VM.

## Snapshot your VM in case you need to roll back

In the Azure portal, use the search bar to find the **Snapshots** functionality. 

![Screenshot showing Azure portal and search bar, with **Snapshots** highlighted](media/ubuntu_upgrade/azure_portal_search_bar.png)

Select **Add**, which will take you to the **Create snapshot** page. Select the subscription and resource group of your virtual machine. For **Region**, select the same region in which the target storage exists. Select the DSVM storage disk and additional backup options. **Standard HDD** is an appropriate storage type for this backup scenario.

Once all the details are filled and validations pass, select **Create** to create the snapshot.

![tk](media/ubuntu_upgrade/image2.png)

![tk](media/ubuntu_upgrade/image3.PNG)


![tk](media/ubuntu_upgrade/image4.PNG)

When the snapshot successfully completes, you will see a "Your deployment is complete" message.

![tk](media/ubuntu_upgrade/image5.PNG)

## In-place migration

If you are migrating an older Ubuntu release, you may choose to do an in-place migration. This migration does not create a new virtual machine and has fewer steps than a side-by-side migration. 

From the Azure portal, start your DSVM and sign in using SSH. To do so, select **Connect** and **SSH** and follow the connection instructions. 

Once connected to a terminal session on your DSVM, run the following upgrade command:

```bash
sudo do-release-upgrade
```

The upgrade process will take a while to complete. When it is over, the program will ask for permission to restart the virtual machine. Answer **Yes**. You will be disconnected from the SSH session as the system reboots.

{>> Kill text, save images below <<}

### Login to Ubuntu VM![tk](media/ubuntu_upgrade/image6.png)

Copy the '**SSH**' from '**Connect'** tab of VM

![tk](media/ubuntu_upgrade/image7.PNG)

Paste the '**SSH'** string in **CLI/Powershell** and enter the
**credentials**

![tk](media/ubuntu_upgrade/image8.PNG)

Press '**Enter'** and now you are logged in to the VM

### Enter the following commands in the Ubuntu VM and press **Enter.**

\$ sudo do-release-upgrade

Enter the '**Command'** and Press '**Enter'**

![tk](media/ubuntu_upgrade/image10.PNG)

Wait until the upgradation completes.

![tk](media/ubuntu_upgrade/image11.png)

### After completion of upgradation. The VM will ask you to restart it. Type '**Y'** and press '**Enter'.**

![tk](media/ubuntu_upgrade/image12_post_upgrade_completion.PNG)

### If necessary, regenerate SSH keys

 [!IMPORTANT] After upgrading and rebooting, you may need to regenerate your SSH keys.

After your VM has upgraded and rebooted, attempt to access it again via SSH. Note that the IP address may have changed during the reboot, so confirm it before attempting to connect.

If you receive the error **REMOTE HOST IDENTIFICATION HAS CHANGED**, you will need to regenerate your SSH credentials.

![tk](media/ubuntu_upgrade/image13.png)

To do so, on your local machine, run the command:

```bash
ssh-keygen -R "your server hostname or ip"
```

You should now be able to connect with SSH. If you are still having trouble, in the **Connect** page follow the link to **Troubleshoot SSH connectivity issues**.

## Side-by-side migration

If you are migrating from CentOS or desire a clean OS install, you can do a side-by-side migration. This type of migration has more steps, but gives you control over exactly which files are carried over.

Migrations from other systems based on the same set of upstream source packages should be relatively straightforward, for example [FAQ/CentOS3](https://wiki.centos.org/FAQ/CentOS3).

You may choose to upgrade the operating system parts of the filesystem and leave user directories, such as `/home` in place. If you do leave the old user home directories in place expect some problems with the GNOME/KDE menus and other desktop items. It may be easiest to create new user accounts and mount the old directories somewhere else in the filesystem for reference, copying, or linking users' material after the migration.

### Migration at a glance

1.  Create a snapshot of your existing VM as described previously

1.  Create a disk from that snapshot

1.  Create a new Ubuntu Data Science Virtual Machine

1.  Recreate user account(s) on the new virtual machine

1.  Mount the disk of the snapshotted VM as a data disk on your new Data Science Virtual Machine

1.  Manually copy the desired data

### Create a disk from your VM snapshot

If you have not already created a VM snapshot as described above, do so. 

In the Azure portal, search for **Managed Disks** and select **Add**. This will bring up the **Disk** page.

Set the **Subscription**, **Resource group**, and **Region** to the values of your VM snapshot. Choose a **Name** for the disk to be created.

Select **Source type** as **Snapshot** and select the VM snapshot as the **Source snapshot**. Review and create the disk. 

{>> moved <<}

4. Create a **Disk** from that snapshot, In the Azure Portal, type **\'Disk\'** in the search bar.

![tk](media/ubuntu_upgrade/centos_8.png)

Fig 4(a) -- Type 'disk' and select from dropdown

5. On the **Disk** page, select the **\'+ Add\'** option in the top left.

![tk](media/ubuntu_upgrade/centos_9.png)

Fig 5(a) -- Select the '+Add' option

6. During creation for **\'Source type\'** choose **\"Snapshot\"** and a new drop menu will appear to let you select the previously created snapshot.

![tk](media/ubuntu_upgrade/centos_10.png)

{>> end <<}

### Create a new Ubuntu Data Science Virtual Machine

Create a new Ubuntu Data Science Virtual Machine using the [Azure portal](https://portal.azure.com) or an [ARM template](https://docs.microsoft.com/azure/machine-learning/data-science-virtual-machine/dsvm-tutorial-resource-manager). 

### Recreate user account(s) on your new Data Science Virtual Machine

Since you will just by copying data from your old computer, you will need to recreate whichever user accounts and software environments that you want to use on the new machine.

Linux is flexible enough to allow you to customize directories and paths on your new installation to follow your old machine. In general, though, it's easier to use the modern Ubuntu's preferred layout and modify your user environment and scripts to adapt.

For more information, see [Quickstart: Set up the Data Science Virtual Machine for Linux (Ubuntu)](https://docs.microsoft.com/azure/machine-learning/data-science-virtual-machine/dsvm-ubuntu-intro).

### Mount the disk of the snapshotted VM as a data disk on your new Data Science Virtual Machine

In the Azure portal, go to the page of your Data Science Virtual Machine. Choose the **Disks** blade on the left rail. Choose **Attach existing disks**. 

In the **Disk name** dropdown, select the disk that you created from your old VM's snapshot.

![tk](tk)

Select **Save** to update your virtual machine.

### Manually copy the desired data 

Start your Data Science Virtual Machine and sign on using SSH. 

{>> mmm... I think you have to mount the disk, right? And then update fstab? <<}

**Move** or **Copy** the necessary directories or files from the **CentOS VM** to the **Ubuntu VM** in the appropriate directories for the services.

{>> keep for images <<}

9. **SSH** into the **VM** to access it.

![tk](media/ubuntu_upgrade/centos_15.png)

Fig 9(a) - Select SSH From connect TAB in overview section

![tk](media/ubuntu_upgrade/centos_16.png)

Fig 9(b) -- Copy the SSH string

![tk](media/ubuntu_upgrade/centos_17.png)

Fig 9(c) - Paste the SSH string on power shell with key path

![tk](media/ubuntu_upgrade/centos_18.png)

Fig 9(d) -- Enter the password to login and access the VM

[!NOTE] You do not need to partition this disk as it is already set up.

10. **Move** or **Copy** the necessary directories or files from the **CentOS VM** to the **Ubuntu VM** in the appropriate directories for the services.

## Cold Migration

1.  Moving a powered off or suspended virtual machine to a new host. Optionally, you can relocate configuration and disk files for powered off or suspended virtual machines to new storage locations.

2.  You can also use cold migration to move virtual machines from one virtual switch to another, and from one data centre to another. You can perform cold migration manually or you can schedule a task.

## Steps to Perform Cold Migration

1. Go to the [Azure portal](https://portal.azure.com/) to manage the resource group containing the VM to move. Search for and select **Resource groups.**

![tk](media/ubuntu_upgrade/centos_19.png)

2. Choose the resource group containing the VM that you would like to move. At the top of the page for the resource group, select **Move** and then select **Move to another subscription**. The **Move resources** page opens.

![tk](media/ubuntu_upgrade/centos_20.png)

3. Select each of the resources to move. In most cases, you should move all of the related resources that are listed and then Select an existing **Resource group**, or enter a name to have a new resource group created.

![tk](media/ubuntu_upgrade/centos_21.png)

Fig 3(a) - Select the target resource group from drop-down.

4. When you are done, select that you understand that new resource IDs will be created and that the new IDs will need to be used with the VM after it is moved, and then select **OK**. It will validate before migration.

![tk](media/ubuntu_upgrade/centos_22.png)
![tk](media/ubuntu_upgrade/centos_23.png)

Fig 4(a) -- Click **OK** Fig 4(b) - Validation

## Connect and confirm version upgrade

Whether you did an in-place or side-by-side migration, confirm that you've successfully upgraded. From a terminal session, run: 


```bash
cat /etc/os-release
```

And you should see that you're running Ubuntu 18.04.

![tk](media/ubuntu_upgrade/image15.PNG)

The change of version is also shown in the Azure portal.

![tk](media/ubuntu_upgrade/image16.png)

## Next steps

- [Data science with an Ubuntu Data Science Machine in Azure](https://docs.microsoft.com/azure/machine-learning/data-science-virtual-machine/linux-dsvm-walkthrough)
- [What tools are included on the Azure Data Science Virtual Machine?](https://docs.microsoft.com/azure/machine-learning/data-science-virtual-machine/tools-included)
