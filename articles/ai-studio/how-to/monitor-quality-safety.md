---
title: Monitor quality and token usage of deployed prompt flow applications (preview)
titleSuffix: Azure AI Studio
description: Learn how to monitor quality and token usage of deployed prompt flow applications with Azure AI Studio.
manager: scottpolly
ms.service: azure-ai-studio
ms.custom:
  - ignite-2023
ms.topic: how-to
ms.date: 04/24/2024
ms.reviewer: alehughes
reviewer: ahughes-msft
ms.author: mopeakande
author: msakande

---

# Monitor quality and token usage of deployed prompt flow applications (preview)

## Add preview disclaimer for AI Studio

Monitoring applications that are deployed to production is an essential part of the generative AI application lifecycle. Changes in data and consumer behavior can influence your application over time, resulting in outdated systems that negatively affect business outcomes and expose organizations to compliance, economic, and reputation risks. 

Azure AI monitoring for generative AI applications enables you to monitor your applications in production for token usage, generation quality, and operational metrics.

Capabilities and integrations for monitoring a prompt flow deployment include: 
- Collect production inference data using the [data collector](https://learn.microsoft.com/en-us/azure/machine-learning/concept-data-collection?view=azureml-api-2).
- Apply Responsible AI evaluation metrics such as groundedness, coherence, fluency, and relevance, which are interoperable with prompt flow evaluation metrics.
- Monitor prompt, completion, and total token usage across each model deployment in your prompt flow.
- Monitor operational metrics, such as request count, latency, and error rate.
- Preconfigured alerts and defaults to run monitoring on a recurring basis.
- Consume data visualizations and configure advanced behavior in Azure AI Studio.

## Monitoring metrics and requirements 

Monitoring metrics are generated by the following state-of-the-art GPT language models configured with specific evaluation instructions (prompt templates) which act as evaluator models for sequence-to-sequence tasks. This technique has strong empirical results and high correlation with human judgment when compared to standard generative AI evaluation metrics. For more information about prompt flow evaluation, see [submit bulk test and evaluate a flow](./flow-bulk-test-evaluation.md) and [evaluation and monitoring metrics for generative AI](../concepts/evaluation-metrics-built-in.md).

These GPT models are supported with monitoring and configured as your Azure OpenAI resource: 

- GPT-3.5 Turbo 
- GPT-4 
- GPT-4-32k 

The following metrics are supported for monitoring:

| Metric       | Description |
|--------------|-------------|
| Groundedness | Measures how well the model's generated answers align with information from the source data (user-defined context.) |
| Relevance    | Measures the extent to which the model's generated responses are pertinent and directly related to the given questions. |
| Coherence    | Measures the extent to which the model's generated responses are logically consistent and connected. |
| Fluency      | Measures the grammatical proficiency of a generative AI's predicted answer. |

When creating your flow, you need to ensure your column names are mapped. The following input data column names are used to measure generation safety and quality: 

| Input column name | Definition | Required |
|------|------------|----------|
| Prompt text | The original prompt given (also known as "inputs" or "question") | Required |
| Completion text | The final completion from the API call that is returned (also known as "outputs" or "answer") | Required |
| Context text | Any context data that is sent to the API call, together with original prompt. For example, if you hope to get search results only from certain certified information sources/website, you can define in the evaluation steps. | Optional |

What parameters are configured in your data asset dictates what metrics you can produce, according to this table: 

| Metric       | Prompt  | Completion | Context |
|--------------|---------|------------|---------|
| Coherence    | Required | Required   | -       | 
| Fluency      | Required | Required   | -       | 
| Groundedness | Required | Required   | Required|
| Relevance    | Required | Required   | Required|

For more information, see [question answering metric requirements](evaluate-generative-ai-app.md#question-answering-metric-requirements).

## Set up monitoring for prompt flow 

Follow these steps to set up monitoring for your prompt flow deployment:

1. After creating your prompt flow, confirm it runs successfully and that the required inputs and outputs are configured for the [metrics you want to assess](#evaluation-metrics). The minimum required parameters of collecting only inputs and outputs provide only two metrics: coherence and fluency. You must configure your flow according to the [flow and metric configuration requirements](#flow-and-metric-configuration-requirements). In this example, we have `question` and `chat_history` as our inputs, and `answer` as our output.

    :::image type="content" source="../media/deploy-monitor/monitor/user-experience.png" alt-text="Screenshot of prompt flow editor with deploy button." lightbox = "../media/deploy-monitor/monitor/user-experience.png":::

1. Deploy your flow. Ensure that **Inferencing data collection** is enabled, which will seamlessly collect your application's inference data to Blob storage. This is required for monitoring. 

    :::image type="content" source="../media/deploy-monitor/monitor/basic-settings.png" alt-text="Screenshot of basic settings in the deployment wizard." lightbox = "../media/deploy-monitor/monitor/basic-settings.png":::

   After completing the **Advanced settings**, review the deployment configuration and deploy your flow by selecting **Create**.

    :::image type="content" source="../media/deploy-monitor/monitor/deployment-with-data-collection-enabled.png" alt-text="Screenshot of review page in the deployment wizard with all settins completed" lightbox = "../media/deploy-monitor/monitor/basic-settings-with-connections-specified.png":::

1. By default, all outputs of your deployment are collected using Azure AI's Model Data Collector. As an optional step, you can enter the advanced settings to confirm that your desired columns (for example, context of ground truth) are included in the endpoint response. 

    Your deployed flow needs to be configured in the following way:  
    - Flow inputs & outputs: You need to name your flow outputs appropriately and remember these column names when creating your monitor. In this article, we use the following settings: 
      - Inputs (required): "prompt" 
      - Outputs (required): "completion" 
      - Outputs (optional): "context" and/or "ground truth" 

    - Data collection: The **inferencing data collection** toggle must be enabled using Model Data Collector 

    - Outputs: In the prompt flow deployment wizard, confirm the required outputs are selected (such as completion, context, and ground_truth) that meet your metric configuration requirements.

1. Test your deployment in the deployment **Test** tab to ensure that it is working properly. 

    :::image type="content" source="../media/deploy-monitor/monitor/test-deploy.png" alt-text="Screenshot of the deployment test page." lightbox = "../media/deploy-monitor/monitor/test-deploy.png":::

    > [!NOTE]
    > Monitoring requires that at least one data point comes from a source other than the **Test** tab in the deployment. We recommend using the REST API available in the **Consume** tab to send sample requests to your deployment. More information on how to do so can be found [here](https://review.learn.microsoft.com/en-us/azure/ai-studio/how-to/flow-deploy?branch=pr-en-us-273312#create-an-online-deployment). 

1. Navigate to the **Deployments** tab and select the prompt flow deployment you just created after it has successfully been deployed. 

    :::image type="content" source="../media/deploy-monitor/monitor/deployment-page-highlight-monitoring.png" alt-text="Screenshot of the deployment page highlighting generation quality monitoring." lightbox = "../media/deploy-monitor/monitor/deployment-page-highlight-monitoring.png":::

1. Ensure your columns are mapped from your flow as defined in the previous requirements. 

    :::image type="content" source="../media/deploy-monitor/monitor/column-map.png" alt-text="Screenshot of columns mapped for monitoring metrics." lightbox = "../media/deploy-monitor/monitor/column-map.png":::

   Select **Advanced settings** to adjust the sampling rate, 

   :::image type="content" source="../media/deploy-monitor/monitor/column-map-advanced-options.png" alt-text="Screenshot of advanced options when mapping columns for monitoring metrics." lightbox = "../media/deploy-monitor/monitor/column-map-advanced-options.png":::

By default, operational metrics such as requests per minute and request latency show up. The default safety and quality monitoring signal are configured with a 10% sample rate and run on your default workspace Azure OpenAI connection. 

Your monitor is created with default settings:
- 10% sample rate
- 4/5 (thresholds / recurrence)
- Weekly recurrence on Monday mornings
- Alerts are delivered to the inbox of the person that triggered the monitor.

To view more details about your monitoring metrics, you can follow the link to navigate to monitoring in Azure Machine Learning studio, which is a separate studio that allows for more customizations. 

## Consume monitoring results 

After you have created your monitor, it will run daily to compute the token usage and generation quality metrics. Operational metrics are made available in near real-time from the **Operational** tab. Navigate to the **Monitoring (preview)** tab from within the deployment to view the monitoring results. The first thing you will see is an overview of monitoring results during the selected time window. You can use the date picker to change the time window of data you are monitoring. The following metrics are available in this overview:

- **Total request count**: The total number of requests which have been sent to the deployment during the selected time window.
- **Total token count**: The total number of tokens which have been used by the deployment during the selected time window.
- **Prompt token count**: The number of prompt tokens which have been used by the deployment during the selected time window.
- **Completion token count**: The number of completion tokens which have been used by the deployment during the selected time window.

Additionally, the **Token usage** tab is selected by default. In this tab, you can view the token usage of your application over time. You can also view the distribution of prompt and completion tokens over time. You can change the **Trendline scope** to monitor all tokens in the entire application or token usage for a particular deployment (e.g., gpt-4) used within your application. 

:::image type="content" source="../media/deploy-monitor/monitor/monitor-token-usage.png" alt-text="Screenshot showing the token usage on the deployment's monitoring page." lightbox = "../media/deploy-monitor/monitor/monitor-token-usage.png":::

Navigate to the **Generation quality** tab to monitor the quality of your application over time. 

- **Violation count**:
- **Average score**: 

:::image type="content" source="../media/deploy-monitor/monitor/generation-quality-trendline.png" alt-text="Screenshot showing the generation quality trendline on the deployment's monitoring page." lightbox = "../media/deploy-monitor/monitor/generation-quality-trendline.png":::

Monitoring also provides a comprehensive table of all sampled requests (if 100 requests were sent in total, and the sampling rate is 10%, you will see 10 sampled requests in the table) sent to the deployment during the selected time window. 

:::image type="content" source="../media/deploy-monitor/monitor/generation-quality-tracing-information.png" alt-text="Screenshot showing the trace button for the generation quality." lightbox = "../media/deploy-monitor/monitor/generation-quality-tracing-information.png":::

:::image type="content" source="../media/deploy-monitor/monitor/trace-information.png" alt-text="Screenshot showing the trace information." lightbox = "../media/deploy-monitor/monitor/trace-information.png":::

You can also view the operational metrics for the deployment by navigating to the **Operational** tab. We support the following operational metrics:

- Request count
- Latency
- Error rate

:::image type="content" source="../media/deploy-monitor/monitor/deployment-operational-tab.png" alt-text="Screenshot of the operational tab for the deployment." lightbox = "../media/deploy-monitor/monitor/deployment-operational-tab.png":::

## Advanced monitoring configuration with SDK v2

Monitoring also supports advanced configuration options with the SDK v2. 

### Enable Monitoring for token usage 

## Next steps

- Learn more about what you can do in [Azure AI Studio](../what-is-ai-studio.md)
- Get answers to frequently asked questions in the [Azure AI FAQ article](../faq.yml)
